---
import Layout from "@/layout/Layout.astro";
import SwitchCard from "@/components/switch_card.astro";

console.log("power/index> power")
---
<Layout title="Heat" >
	<ul class="power page">
		<li>
			<SwitchCard name="mesh" />
		</li>
		<li>
			<SwitchCard name="lifx" />
		</li>
		<li>
			<SwitchCard name="poster" />
		</li>
		<li>
			<SwitchCard name="pc" />
		</li>
	</ul>
</Layout>


<style>
ul{
	display:flex;
	flex-direction: row;
	flex-wrap: wrap;
	justify-content: center;
	gap: 10px;
	list-style: none;
	padding: 0px;
}
li{
	border-radius: 10px;
	background-color:rgb(112, 112, 112);
	overflow: hidden;
    box-shadow: 2px 1px 10px rgb(123, 123, 123);
}
li:hover{
	box-shadow: 4px 5px 5px #ccc;
}

</style>

<script>
	import {event} from "../../libs/client_utils"
	console.log("client:power> script()")
	function dispatch_power_state(data){
		Object.keys(data).forEach((name)=>{
			const card = document.querySelector(`.card[data-name="${name}"]`)
			if(!card){
				console.log(name)
			}
			event(card,"update",data[name])
		})
	}
	function setup_sse(){
		const evtSource = new EventSource("/api/power_events")
	
		evtSource.onmessage = (event) => {
			dispatch_power_state(JSON.parse(event.data))
		}
		evtSource.onerror = (err) => {
			  console.error("EventSource failed:", err);
			  evtSource.close();
		};	
	}
	setup_sse()
</script>
